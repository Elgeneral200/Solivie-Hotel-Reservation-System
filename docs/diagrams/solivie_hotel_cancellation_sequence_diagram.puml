@startuml Cancellation Sequence Diagram

skinparam {
  backgroundColor #FFFFFF
  defaultFontName Segoe UI
  defaultFontSize 10
  shadowing true
  shadowingIntensity 15
  
  ParticipantBackgroundColor #FFFFFF
  ParticipantBorderColor #2C3E50
  ParticipantBorderThickness 2
  ParticipantFontColor #2C3E50
  ParticipantFontSize 11
  ParticipantFontStyle bold
  
  ActorBackgroundColor #FFEBEE
  ActorBorderColor #D32F2F
  ActorFontColor #2C3E50
  ActorFontSize 11
  ActorFontStyle bold
  
  DatabaseBackgroundColor #F3E5F5
  DatabaseBorderColor #7B1FA2
  DatabaseFontColor #2C3E50
  DatabaseFontSize 11
  DatabaseFontStyle bold
  
  ArrowColor #2C3E50
  ArrowThickness 1.5
  ArrowFontColor #2C3E50
  ArrowFontSize 9
  
  NoteBackgroundColor #FFF3E0
  NoteBorderColor #FF9800
  NoteFontColor #5D4037
  NoteFontSize 9
  NoteRoundCorner 8
  
  LifeLineBackgroundColor #F5F5F5
  LifeLineBorderColor #BDBDBD
}

title <color:#2C3E50><size:16><b>SOLIVIE HOTEL - CANCELLATION WORKFLOW SEQUENCE DIAGRAM</b></size></title>

caption <color:#546E7A><i>Complete booking cancellation process with refund management</i></caption>

actor "Hotel Guest" as User <<Customer>>
participant "Bookings Portal" as BP <<UI>>
participant "Booking Manager" as BM <<Controller>>
participant "Cancellation Handler" as CH <<Service>>
participant "Refund Processor" as RM <<Service>>
participant "Payment Gateway" as PG <<External>>
participant "Email Service" as Email <<Service>>
participant "Loyalty Program" as LP <<Service>>
database "Hotel Database" as DB <<PostgreSQL>>

' ============================================
' PHASE 1: BOOKING RETRIEVAL
' ============================================

User -> BP: **1. ACCESS bookings_portal**\nğŸ“‹ View reservations
note right of User
  <color:#2C3E50><b>User Action</b></color>
  â€¢ Navigate to "My Bookings"
  â€¢ Authenticated session
  â€¢ View reservation history
  â€¢ Select booking to manage
end note

activate BP

BP -> DB: **2. QUERY user_bookings**\nğŸ“Š Retrieve active bookings
activate DB

DB --> BP: **3. RETURN bookings_list**\nâœ… Active reservations
deactivate DB

BP --> User: **4. DISPLAY bookings_dashboard**\nğŸ¯ Interactive list
deactivate BP

' ============================================
' PHASE 2: CANCELLATION INITIATION
' ============================================

User -> BP: **5. SELECT booking**\nâŒ Choose to cancel
activate BP

BP -> BM: **6. get_booking_details()**\nğŸ“‹ Fetch complete info
activate BM

BM -> DB: **7. SELECT booking_record**\nğŸ” Full booking data
activate DB
DB --> BM: **8. RETURN booking_details**\nâœ… Complete information
deactivate DB

BM --> BP: **9. RETURN enriched_data**\nğŸ“¦ Booking + status
deactivate BM

' ============================================
' PHASE 3: POLICY VALIDATION
' ============================================

BP -> CH: **10. validate_cancellation()**\nâœ… Check eligibility
activate CH
note right of CH
  <color:#2C3E50><b>Validation Checks</b></color>
  â€¢ Booking status verification
  â€¢ Check-in date comparison
  â€¢ Policy applicability
  â€¢ User permissions
end note

CH -> CH: **11. calculate_days_until_checkin()**\nğŸ“… Time calculation
CH -> CH: **12. apply_policy_rules()**\nâš–ï¸ Business logic

CH --> BP: **13. RETURN eligibility_status**\nâœ… Eligible for cancellation
deactivate CH

BP -> CH: **14. calculate_refund_amount()**\nğŸ’° Financial computation
activate CH

CH -> CH: **15. compute_refund()**\nğŸ§® Apply policy formula
note right of CH
  <color:#2C3E50><b>Refund Calculation</b></color>
  â€¢ Base amount: $500
  â€¢ Days until check-in: 4
  â€¢ Policy: 50% refund (3-6 days)
  â€¢ Refund amount: $250
  â€¢ Processing fee: $25
  â€¢ Net refund: $225
end note

CH --> BP: **16. RETURN refund_details**\nğŸ’µ Calculated amount
deactivate CH

' ============================================
' PHASE 4: USER CONFIRMATION
' ============================================

BP --> User: **17. DISPLAY cancellation_summary**\nğŸ“‹ Policy + Refund
note right of BP
  <color:#2C3E50><b>Display Contents</b></color>
  â€¢ Cancellation policy details
  â€¢ Calculated refund amount
  â€¢ Processing timeline
  â€¢ Alternative options
  â€¢ Confirmation required
end note

User -> BP: **18. CONFIRM cancellation**\nâœ… Final approval
note right of User
  <color:#2C3E50><b>User Decision</b></color>
  â€¢ Review refund amount
  â€¢ Accept policy terms
  â€¢ Provide cancellation reason
  â€¢ Confirm irreversible action
end note

' ============================================
' PHASE 5: BOOKING CANCELLATION
' ============================================

BP -> BM: **19. cancel_booking()**\nğŸš€ Execute cancellation
activate BM

BM -> DB: **20. UPDATE booking_status**\nğŸ“Š Set to 'CANCELLED'
activate DB
DB --> BM: **21. RETURN success**\nâœ… Status updated
deactivate DB

BM -> DB: **22. UPDATE room_availability**\nğŸ”„ Release inventory
activate DB
DB --> BM: **23. RETURN success**\nâœ… Room available
deactivate DB

BM -> DB: **24. INSERT cancellation_record**\nğŸ“‹ Create audit trail
activate DB
DB --> BM: **25. RETURN cancellation_id**\nğŸ« CAN-2023-001
deactivate DB

BM --> BP: **26. RETURN cancellation_confirmed**\nâœ… Process complete
deactivate BM

' ============================================
' PHASE 6: LOYALTY POINTS ADJUSTMENT
' ============================================

BP -> LP: **27. adjust_loyalty_points()**\nğŸ† Points reversal
activate LP

LP -> DB: **28. SELECT loyalty_transactions**\nğŸ“Š Find awarded points
activate DB
DB --> LP: **29. RETURN points_data**\nâœ… Points information
deactivate DB

LP -> DB: **30. REVERSE loyalty_points**\nğŸ“‰ Deduct from balance
activate DB
DB --> LP: **31. RETURN new_balance**\nğŸ’° Updated points
deactivate DB

LP -> DB: **32. LOG points_adjustment**\nğŸ“‹ Audit trail
activate DB
DB --> LP: **33. RETURN adjustment_id**\nâœ… Adjustment recorded
deactivate DB

LP --> BP: **34. RETURN points_updated**\nğŸ† Adjustment complete
deactivate LP

' ============================================
' PHASE 7: REFUND PROCESSING
' ============================================

BP -> RM: **35. initiate_refund()**\nğŸ’³ Start refund process
activate RM

RM -> DB: **36. SELECT payment_details**\nğŸ“Š Original transaction
activate DB
DB --> RM: **37. RETURN payment_info**\nâœ… Transaction data
deactivate DB

RM -> PG: **38. process_refund()**\nğŸ” Secure API call
activate PG
note right of PG
  <color:#2C3E50><b>Payment Gateway</b></color>
  â€¢ Refund authorization
  â€¢ Transaction verification
  â€¢ Fraud prevention check
  â€¢ Real-time processing
end note

PG --> RM: **39. RETURN refund_receipt**\nâœ… RREF-789012
deactivate PG

RM -> DB: **40. INSERT refund_record**\nğŸ’¾ Save transaction
activate DB
DB --> RM: **41. RETURN refund_id**\nğŸ’° REF-2023-001
deactivate DB

RM --> BP: **42. RETURN refund_processed**\nâœ… Funds returned
deactivate RM

' ============================================
' PHASE 8: NOTIFICATIONS
' ============================================

BP -> Email: **43. send_cancellation_notice()**\nğŸ“§ Prepare notifications
activate Email

Email -> Email: **44. generate_cancellation_email()**\nğŸ¨ Create content
note right of Email
  <color:#2C3E50><b>Email Components</b></color>
  â€¢ Personalized cancellation notice
  â€¢ Refund details summary
  â€¢ Policy reference
  â€¢ Future booking incentives
  â€¢ Customer support contact
end note

Email -> User: **45. DELIVER cancellation_email**\nğŸ“¨ Send notification
note right of Email
  <color:#2C3E50><b>Email Contents</b></color>
  â€¢ Cancellation confirmation
  â€¢ Refund amount and timeline
  â€¢ Cancellation reference number
  â€¢ Rebooking offers
  â€¢ Feedback request
end note

Email -> BP: **46. NOTIFY hotel_staff**\nğŸ‘¥ Internal alert
Email -> BP: **47. UPDATE revenue_dashboard**\nğŸ“Š Financial impact

Email --> BP: **48. RETURN notifications_sent**\nâœ… All alerts delivered
deactivate Email

' ============================================
' PHASE 9: COMPLETION
' ============================================

BP --> User: **49. DISPLAY confirmation_screen**\nğŸ‰ Process complete
note right of BP
  <color:#2C3E50><b>Confirmation Display</b></color>
  â€¢ Cancellation reference: CAN-2023-001
  â€¢ Refund amount: $225.00
  â€¢ Processing time: 5-7 business days
  â€¢ Next steps and options
  â€¢ Support contact information
end note

deactivate BP

' ============================================
' SUMMARY & LEGEND
' ============================================

note over User, DB
  <color:#2C3E50><b>Process Summary</b></size></color>
  
  <b>â±ï¸ Total Duration:</b> 3-10 seconds
  <b>ğŸ“Š Database Operations:</b> 15+ transactions
  <b>ğŸ”— External Calls:</b> Payment Gateway API
  <b>ğŸ“§ Notifications:</b> Customer + Internal
  
  <b>Key Performance Indicators:</b>
  â€¢ Refund processing time: < 24h
  â€¢ System availability: 99.9%
  â€¢ Customer satisfaction: > 90%
  â€¢ Error rate: < 0.1%
  
  <b>Compliance & Security:</b>
  â€¢ PCI DSS compliance for refunds
  â€¢ Data protection regulations
  â€¢ Audit trail maintenance
  â€¢ Fraud detection protocols
end note

legend right
  | <b>Component Type</b> | <b>Color</b> |
  | Customer/Actor | <color:#D32F2F>â–ˆ</color> |
  | User Interface | <color:#2C3E50>â–ˆ</color> |
  | Controller/Manager | <color:#1976D2>â–ˆ</color> |
  | Service Layer | <color:#388E3C>â–ˆ</color> |
  | External System | <color:#FF9800>â–ˆ</color> |
  | Database | <color:#7B1FA2>â–ˆ</color> |
  | **Process Step** | **Icon** |
  | Data Retrieval | ğŸ“Š |
  | Calculation | ğŸ§® |
  | Update Operation | ğŸ”„ |
  | Notification | ğŸ“§ |
  | External API | ğŸ”— |
  | Success | âœ… |
end legend

@enduml